{"version":3,"file":"ssr.cjs","names":["target: Element","element: Element","key: string","rawValue?: PropValueOrAccessor","styleObject: T","key: keyof T","value: T[keyof T]","styleValue?: FunctionMaybe<CSSProperties | string | null | undefined>","target: DOMElement","parent: DOMElement","child?:\n    | FunctionMaybe<RegExp | Date>\n    | Accessor<MaybeChildNode>\n    | MaybeChildNode\n    | Promise<MaybeChildNode>","target: DOMElement","_event: K","_handler:\n    & EventListenerObject[\"handleEvent\"]\n    & ((e: HTMLElementEventMap[K]) => void)","_options?: AddEventListenerOptions","tagName: K","first?: MaybeChildNode | DOMNodeAttributes<PotentialProps<K>, K>","props: ListProps<T>","file: string","modules: string[]","manifest: Record<string, string[]>"],"sources":["../src/ssr/attr.ts","../src/ssr/h.ts","../src/ssr/flow.ts","../src/ssr/preload.ts"],"sourcesContent":["import type {\n  CSSProperties,\n  DOMElement,\n  FunctionMaybe,\n  PropValueOrAccessor,\n} from \"../types/types\";\nimport {\n  isFunction,\n  isObject,\n  needsEncoding,\n  urlAttributes,\n} from \"../util\";\nimport { escape } from \"@thednp/domparser\";\n\nexport const setHydrationKey = (target: Element) =>{\n  !target.hasAttribute(\"data-hk\") && target.setAttribute(\"data-hk\", \"\"); \n}\n\n/**\n * Sets or removes an attribute with the specified or inferred namespace on an element.\n * @param element - The DOM element to modify.\n * @param key - The attribute name (e.g., 'stroke-width', 'xlink:href').\n * @param value - The attribute value; falsy values remove the attribute.\n */\nexport const setAttribute = (\n  element: Element,\n  key: string,\n  rawValue?: PropValueOrAccessor,\n) => {\n  const value = isFunction(rawValue) ? rawValue() : rawValue;\n  const attrKey = key.indexOf(\":\") > -1 ? key.replace(/^[^:]+:/, \"\") : key;\n\n  // Determine attribute namespace\n  if (value == null || value === false || value === \"\" || value === undefined) {\n    element.removeAttribute(attrKey);\n    element.removeAttribute(key);\n  } else {\n    const t = typeof value;\n    const attrValue = value === true\n      ? \"\"\n      : t === \"number\"\n      ? String(value)\n      : !urlAttributes.includes(key)\n      ? escape(value as string)\n      : (needsEncoding(key, value as string)\n        ? encodeURI(value as string)\n        : value);\n\n    isFunction(rawValue) && setHydrationKey(element);\n    element.setAttribute(attrKey, attrValue as string);\n  }\n};\n\nexport const getStyleObject = <T extends CSSProperties>(styleObject: T) => {\n  const output = {} as T;\n  let key: keyof T;\n  let value: T[keyof T];\n  for (const [objKey, rawValue] of Object.entries(styleObject)) {\n    key = objKey.split(/(?=[A-Z])/).join(\"-\").toLowerCase() as keyof T;\n    // allow state values in style object\n    value = (isFunction(rawValue) ? rawValue() : rawValue) as T[keyof T]\n    if (value) output[key] = value;\n  }\n  return output;\n};\n\n/**\n * Allows the \"framework\" to support CSS objects\n */\nexport const styleToString = (\n  styleValue?: FunctionMaybe<CSSProperties | string | null | undefined>,\n) => {\n  const styleVal = isFunction(styleValue) ? styleValue() : styleValue;\n  return typeof styleVal === \"string\"\n    ? styleVal\n    : isObject(styleVal)\n    ? Object.entries(getStyleObject(styleVal)).reduce(\n      (acc, [key, value]) => acc + key + \":\" + value + \";\",\n      \"\",\n    )\n    : \"\";\n};\n\nexport const style = (\n  target: DOMElement,\n  styleValue?: FunctionMaybe<CSSProperties | string | null | undefined>,\n) => {\n  const styleVal = isFunction(styleValue) ? styleValue() : styleValue;\n  const hasReactiveProp = isObject(styleVal) && Object.values(styleVal).some(sv => isFunction(sv));\n\n  setAttribute(target, \"style\", styleToString(styleVal));\n  if (isFunction(styleValue) || hasReactiveProp)\n    setHydrationKey(target);\n};\n","import { createDocument } from \"@thednp/domparser\";\n\n// src/h.ts\nimport { setAttribute, setHydrationKey, style } from \"./attr\";\nimport type {\n  DOMElement,\n  DOMNodeAttributes,\n  FunctionMaybe,\n  MaybeChildNode,\n  OutputElement,\n  PotentialProps,\n  Primitive,\n  TagNames,\n} from \"../types/types\";\nimport {\n  getStringValue,\n  isArray,\n  isFunction,\n  isNode,\n  isObject,\n} from \"../util\";\nimport type { Accessor } from \"../types/types\";\n\nif (typeof document === \"undefined\") {\n  // @ts-expect-error this is server code\n  globalThis.document = createDocument();\n}\n\n// Append children\nexport const add = (\n  parent: DOMElement,\n  child?:\n    | FunctionMaybe<RegExp | Date>\n    | Accessor<MaybeChildNode>\n    | MaybeChildNode\n    | Promise<MaybeChildNode>,\n) => {\n  if (!parent || !child) return;\n\n  if (child instanceof Promise) {\n    child.then((resolved) => add(parent, resolved));\n  } else if (isArray(child)) {\n    child.forEach((c) => add(parent, c));\n  } else if (isNode(child)) {\n    parent.appendChild(child);\n  } else if (isFunction(child)) {\n    const textNode = document.createTextNode(\"\");\n    parent.appendChild(textNode);\n    const realChild = (isFunction(child()) ? child() : child) as Accessor<\n      MaybeChildNode\n    >;\n\n    const value = realChild();\n    if (isArray(value)) {\n      parent.textContent = \"\";\n      value.forEach((v) => add(parent, v));\n    } else if (isNode(value)) { // Node\n      add(parent, child);\n    } else { // string | number | bigint | boolean | symbol | Date | RegExp\n      textNode.textContent = getStringValue(\n        value as Primitive | RegExp | Date,\n      );\n    }\n  } else {\n    parent.appendChild(document.createTextNode(getStringValue(child)));\n  }\n};\n\nexport function listen<K extends keyof HTMLElementEventMap>(\n  target: DOMElement,\n  _event: K,\n  _handler:\n    & EventListenerObject[\"handleEvent\"]\n    & ((e: HTMLElementEventMap[K]) => void),\n  _options?: AddEventListenerOptions,\n) {\n  setHydrationKey(target);\n  return true;\n}\n\nexport function h<K extends TagNames>(\n  tagName: K,\n  first?: MaybeChildNode | DOMNodeAttributes<PotentialProps<K>, K>,\n  ...children: MaybeChildNode[]\n): OutputElement<K> {\n  const element = document.createElement(tagName) as OutputElement<K>;\n\n  // Handle props if first is an object and not a Node\n  if (isObject(first) && !isNode(first) && !isArray(first)) {\n    Object.entries(first).forEach(([key, value]) => {\n      if (key.startsWith(\"on\")) {\n        if (isFunction(value)) setHydrationKey(element);\n      } else if (key === \"style\") {\n        style(element, value);\n      } else {\n        setAttribute(element, key, value);\n      }\n    });\n  } else {\n    add(element, first);\n  }\n\n  add(element, children);\n\n  return element;\n}\n\n","// src/flow.ts\nimport type { DOMElement, FunctionMaybe, MaybeChildNode } from \"../types/types\";\nimport { isArray, isFunction } from \"../util\";\n\nexport type ListProps<T> = {\n  each?: () => T[];\n  children?: (item: T) => MaybeChildNode;\n};\n\nexport const List = <T>(props: ListProps<T>) => {\n  const { each, children } = props;\n  const placeholder = document.createTextNode(\"\");\n\n  const Layout = () => {\n    const items = each ? each() : [];\n    const nodes = [];\n    if (!children) return;\n\n    for (const item of items) {\n      const node = children(item) as DOMElement;\n      if (node) nodes.push(node);\n    };\n    if (nodes.length) return nodes;\n\n    return placeholder as unknown as DOMElement[];\n  }\n\n  return Layout();\n};\n\nexport function Show<T>({\n  when,\n  children,\n}: {\n  when: FunctionMaybe<T | boolean>;\n  children: () => MaybeChildNode;\n}) {\n  const placeholder = document.createTextNode(\"\");\n  const initialWhen = () => isFunction(when) ? when() : when\n  const newNodes = () => {\n    const nodes = isFunction(children) ? children() : children;\n    return isArray(nodes) ? nodes : [nodes];\n  };\n\n  const Layout = () => {\n    const condition = initialWhen();\n    const nodes = newNodes();\n    if (condition && nodes.length) {\n      return nodes;\n    }\n    return placeholder as unknown as MaybeChildNode;\n  };\n\n  return Layout();\n}\n","import { basename } from \"node:path\";\n\n/**\n * @param file File path\n */\nfunction renderPreloadLink(file: string) {\n    if (file.endsWith(\".js\")) {\n      return `<link rel=\"preload\" href=\"${file}\" as=\"script\" crossorigin>`;\n    } else if (file.endsWith(\".css\")) {\n      return `<link rel=\"preload\" href=\"${file}\" as=\"style\" crossorigin>`;\n    } else if (file.endsWith(\".woff\")) {\n      return ` <link rel=\"preload\" href=\"${file}\" as=\"font\" type=\"font/woff\" crossorigin>`;\n    } else if (file.endsWith(\".woff2\")) {\n      return ` <link rel=\"preload\" href=\"${file}\" as=\"font\" type=\"font/woff2\" crossorigin>`;\n    } else if (file.endsWith(\".gif\")) {\n      return ` <link rel=\"preload\" href=\"${file}\" as=\"image\" type=\"image/gif\">`;\n    } else if (file.endsWith(\".jpg\") || file.endsWith(\".jpeg\")) {\n      return ` <link rel=\"preload\" href=\"${file}\" as=\"image\" type=\"image/jpeg\">`;\n    } else if (file.endsWith(\".png\")) {\n      return ` <link rel=\"preload\" href=\"${file}\" as=\"image\" type=\"image/png\">`;\n    } else if (file.endsWith(\".webp\")) {\n      return ` <link rel=\"preload\" href=\"${file}\" as=\"image\" type=\"image/webp\">`;\n    } else {\n      // @ts-ignore - this is server side code\n      console.warn(\"Render error! File format not recognized: \" + file);\n      return \"\";\n    }\n  }\n  \n  /**\n   * @param modules The list of modules to preload\n   * @param manifest The vite manifest object\n   */\n  export function renderPreloadLinks(modules: string[], manifest: Record<string, string[]>) {\n    let links = \"\";\n    const seen = new Set();\n    const ignoredAssets = new Set();\n  \n    // First pass: collect all assets from ignored paths\n    Object.entries(manifest).forEach(([id, files]) => {\n      // istanbul ignore else - don't pre-render routes, layouts and JSX stuff\n      if (\n        [\"src/pages\", \"src/routes\", \"pakframe/\"].some((l) =>\n          id.includes(l)\n        )\n      ) {\n        files.forEach((asset) => ignoredAssets.add(asset));\n      }\n    });\n  \n    // Second pass: generate preload links\n    modules.forEach((id) => {\n      const files = manifest[id];\n  \n      // istanbul ignore else\n      if (files?.length) {\n        files.forEach((file) => {\n          // Skip if we've seen this file or if it's an asset from an ignored path\n          if (seen.has(file) || ignoredAssets.has(file)) return;\n  \n          seen.add(file);\n          const filename = basename(file);\n  \n          // Handle dependencies\n          // istanbul ignore next - no way to test this\n          if (manifest[filename]) {\n            for (const depFile of manifest[filename]) {\n              // istanbul ignore else\n              if (!seen.has(depFile) && !ignoredAssets.has(depFile)) {\n                links += renderPreloadLink(depFile);\n                seen.add(depFile);\n              }\n            }\n          }\n  \n          links += renderPreloadLink(file);\n        });\n      }\n    });\n  \n    return links;\n  }\n  "],"mappings":"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"}